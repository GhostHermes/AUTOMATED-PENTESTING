# vulnerability_scanning.py
import subprocess
import os
from dotenv import load_dotenv
import logging
from openai import OpenAI, Completion

load_dotenv()
OPENAI_API_KEY = os.getenv("openai_api-key")

# Initialize OpenAI
openai = OpenAI(OPENAI_API_KEY)

# Setup logging
logging.basicConfig(filename='vulnerability_scanning.log', level=logging.INFO)

def get_scanning_choice(urls):
    prompt = f"I have the following URLs to scan: {', '.join(urls)}. Should I use XSS scanning, SQL Injection scanning or Open Redirect scanning?"
    response = openai.Completion.create(
      engine="text-davinci-003",
      prompt=prompt,
      temperature=0.5,
      max_tokens=100
    )
    return response.choices[0].text.strip()

def xss_scanning(urls, output_file):
    logging.info("Running XSS scanning")
    for url in urls:
        # Let's use XSStrike as an example tool
        try:
            xsstrike_path = '/home/v-_-1337/XSStrike'
            subprocess.check_call(['python3', f'{xsstrike_path}/xsstrike.py', '-u', url, '-o', output_file])
            logging.info(f"XSS scanning for {url} completed successfully")
        except subprocess.CalledProcessError as e:
            logging.error(f"XSS scanning for {url} failed with error: {e}")
            raise
        except Exception as e:
            logging.error(f"Unexpected error occurred during XSS scanning for {url}: {e}")
            raise

def sql_injection_scanning(urls, output_file):
    logging.info("Running SQL Injection scanning")
    for url in urls:
        # Let's use SQLMap as an example tool
        try:
            sqlmap_path = '/usr/bin/sqlmap'
            subprocess.check_call(['python3', f'{sqlmap_path}/sqlmap.py', '-u', url, '--batch', '-o', output_file])
            logging.info(f"SQL Injection scanning for {url} completed successfully")
        except subprocess.CalledProcessError as e:
            logging.error(f"SQL Injection scanning for {url} failed with error: {e}")
            raise
        except Exception as e:
            logging.error(f"Unexpected error occurred during SQL Injection scanning for {url}: {e}")
            raise

def open_redirect_scanning(urls, output_file):
    logging.info("Running Open Redirect scanning")
    for url in urls:
        # Let's use Open Redirect Checker as an example tool
        try:
            redirect_checker_path = '/home/v-_-1337/OpenRedirectChecker'
            subprocess.check_call(['python3', f'{redirect_checker_path}/redirect_checker.py', '-u', url, '-o', output_file])
            logging.info(f"Open Redirect scanning for {url} completed successfully")
        except subprocess.CalledProcessError as e:
            logging.error(f"Open Redirect scanning for {url} failed with error: {e}")
            raise
        except Exception as e:
            logging.error(f"Unexpected error occurred during Open Redirect scanning for {url}: {e}")
            raise

if __name__ == "__main__":
    urls = sys.argv[1:]
    output_file = 'vulnerability_scanning_output.txt'
    scanning_choice = get_scanning_choice(urls)
    
    if scanning_choice.lower() == 'xss scanning':
        xss_scanning(urls, output_file)
    elif scanning_choice.lower() == 'sql injection scanning':
        sql_injection_scanning(urls, output_file)
    elif scanning_choice.lower() == 'open redirect scanning':
        open_redirect_scanning(urls, output_file)
    else:
        logging.error(f"Invalid scanning choice: {scanning_choice}")
