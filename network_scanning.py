# network_scanning.py
import subprocess
import sys
from dotenv import load_dotenv
import os
from openai import OpenAI

# Load the environment variables from the .env file
load_dotenv()

# Now you can access the API key using os.getenv
openai = OpenAI(os.getenv('openai_api_key'))

class NetworkScanner:

    def __init__(self, target, output_file):
        self.target = target
        self.output_file = output_file

    def run(self):
        raise NotImplementedError

    def process_output(self, output):
        # Implement common output processing here if needed
        pass

    def check_with_gpt(self, prompt):
        response = openai.Completion.create(
          engine="text-davinci-003.5-turbo",
          prompt=prompt,
          temperature=0.5,
          max_tokens=100
        )
        return response.choices[0].text.strip()

class SubdomainScanner(NetworkScanner):

    def run(self):
        print("Running subdomain discovery on " + self.target)
        decision_prompt = f"Should I run a subdomain scan on {self.target}?"
        decision = self.check_with_gpt(decision_prompt)
        if decision.lower() == 'yes':
            subprocess.call(['python', 'path_to_Sublist3r/sublist3r.py', '-d', self.target, '-o', self.output_file])

class PortScanner(NetworkScanner):

    def run(self):
        print("Running port scanning on " + self.target)
        decision_prompt = f"Should I run a port scan on {self.target}?"
        decision = self.check_with_gpt(decision_prompt)
        if decision.lower() == 'yes':
            subprocess.call(['nmap', '-p', '1-65535', '-T4', '-A', '-v', '-o', self.output_file, self.target])

class DnsScanner(NetworkScanner):

    def run(self):
        print("Running DNS discovery on " + self.target)
        decision_prompt = f"Should I run a DNS scan on {self.target}?"
        decision = self.check_with_gpt(decision_prompt)
        if decision.lower() == 'yes':
            subprocess.call(['host', self.target, '>', self.output_file])
