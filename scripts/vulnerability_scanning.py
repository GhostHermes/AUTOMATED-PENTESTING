import subprocess
import os
from dotenv import load_dotenv
from openai import OpenAI

# Load the environment variables from the .env file
load_dotenv()

# Now you can access the API key using os.getenv
openai = OpenAI(os.getenv('openai_api_key'))

class VulnerabilityScanner:

    def __init__(self, target, output_file):
        self.target = target
        self.output_file = output_file

    def run(self):
        raise NotImplementedError

    def process_output(self, output):
        # Implement common output processing here if needed
        pass

    def check_with_gpt(self, prompt):
        response = openai.Completion.create(
          engine="text-davinci-003.5-turbo",
          prompt=prompt,
          temperature=0.5,
          max_tokens=100
        )
        return response.choices[0].text.strip()

class XssScanner(VulnerabilityScanner):

    def run(self):
        print("Running XSS scanning on " + self.target)
        decision_prompt = f"Should I run an XSS scan on {self.target}?"
        decision = self.check_with_gpt(decision_prompt)
        if decision.lower() == 'yes':
            subprocess.call(['python', 'path_to_XSStrike/xsstrike.py', '-u', self.target, '-o', self.output_file])

class SqlInjectionScanner(VulnerabilityScanner):

    def run(self):
        print("Running SQL Injection scanning on " + self.target)
        decision_prompt = f"Should I run a SQL Injection scan on {self.target}?"
        decision = self.check_with_gpt(decision_prompt)
        if decision.lower() == 'yes':
            subprocess.call(['python', 'path_to_SQLMap/sqlmap.py', '-u', self.target, '--batch', '-o', self.output_file])

class OpenRedirectScanner(VulnerabilityScanner):

    def run(self):
        print("Running Open Redirect scanning on " + self.target)
        decision_prompt = f"Should I run an Open Redirect scan on {self.target}?"
        decision = self.check_with_gpt(decision_prompt)
        if decision.lower() == 'yes':
            subprocess.call(['python', 'path_to_OpenRedirectChecker/redirect_checker.py', '-u', self.target, '-o', self.output_file])
