import os
from dotenv import load_dotenv
from openai import OpenAI
import subprocess

# Load the environment variables from .env file
load_dotenv()

# Get OpenAI key from environment variables
openai_key = os.getenv("OPENAI_KEY")

# Initialize OpenAI client
openai = OpenAI(openai_key)

class NetworkScanner:
    def __init__(self, openai):
        self.openai = openai

    def run(self, target, output_file):
        raise NotImplementedError

    def process_output(self, output):
        # Implement common output processing here if needed
        pass

    def check_with_gpt(self, prompt):
        response = self.openai.Completion.create(
          engine="text-davinci-003.5-turbo",
          prompt=prompt,
          temperature=0.5,
          max_tokens=100
        )
        return response.choices[0].text.strip()

class SubdomainScanner(NetworkScanner):
    def run(self, target, output_file):
        print("Running subdomain discovery on " + target)
        decision_prompt = f"Should I run a subdomain scan on {target}?"
        decision = self.check_with_gpt(decision_prompt)
        if decision.lower() == 'yes':
            subprocess.call(['subfinder', '-d', target, '-o', output_file])

class PortScanner(NetworkScanner):
    def run(self, target, output_file):
        print("Running port scanning on " + target)
        decision_prompt = f"Should I run a port scan on {target}?"
        decision = self.check_with_gpt(decision_prompt)
        if decision.lower() == 'yes':
            subprocess.call(['nmap', '-p', '1-65535', '-T4', '-A', '-v', '-o', output_file, target])

class DnsScanner(NetworkScanner):
    def run(self, target, output_file):
        print("Running DNS discovery on " + target)
        decision_prompt = f"Should I run a DNS scan on {target}?"
        decision = self.check_with_gpt(decision_prompt)
        if decision.lower() == 'yes':
            subprocess.call(['host', target, '>', output_file])
